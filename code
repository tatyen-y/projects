import pandas as pd
import numpy as np

# Загрузка данных
df = pd.read_csv('df.csv')
pop = pd.read_csv('pop.csv')

# Функция для вычисления расстояния по формуле Гаверсина
def haversine(lat1, lon1, lat2, lon2):
    R = 6371  # радиус Земли в километрах
    phi1, phi2 = np.radians(lat1), np.radians(lat2)
    delta_phi = np.radians(lat2 - lat1)
    delta_lambda = np.radians(lon2 - lon1)
    a = np.sin(delta_phi / 2) ** 2 + np.cos(phi1) * np.cos(phi2) * np.sin(delta_lambda / 2) ** 2
    c = 2 * np.arctan2(np.sqrt(a), np.sqrt(1 - a))
    return R * c

# Функция для нахождения ближайшего города и его популяции
def find_nearest_city(construction_lat, construction_lon, cities):
    min_distance = float('inf')
    nearest_city_population = 0
    
    for _, city in cities.iterrows():
        city_coords = (city['LAN'], city['LON'])
        distance = haversine(construction_lat, construction_lon, city_coords[0], city_coords[1])
        
        if distance < min_distance:
            min_distance = distance
            nearest_city_population = city['Population']
    
    return nearest_city_population

# Применение функции к каждому объекту строительства
df['nearest_city_population'] = df.apply(
    lambda row: find_nearest_city(row['coordinates.latitude'], row['coordinates.longitude'], pop), axis=1)

# Сохранение результата
df.to_csv('constructions_with_population.csv', index=False)

# Вывод результата
import ace_tools as tools; tools.display_dataframe_to_user(name="Constructions with Nearest City Population", dataframe=df)

